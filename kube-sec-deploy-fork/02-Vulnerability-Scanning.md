Harbor ships with a vulnerability scanner called Clair, which allows us to check our image for published vulnerabilities ([CVEs](https://cve.mitre.org/about/faqs.html)) before deploying, and to make decisions based on the findings.

Ensure that you have set up Harbor correctly before proceeding.

## Configure Harbor to use Clair

1. Turn on image scanning for the default library project.
    1. Open the Harbor UI.
    2. Select the `library` project, and then click the `Configuration` tab.
    3. Select `Prevent vulnerable images from running` and set the threshold to "low". This will prevent vulnerable images with one or more low vulnerability CVEs from getting pulled from this repository.
    4. Set the option to scan on push.
1. If left alone, the registry will eventually pull the vulnerability database from the internet, however depending on bandwidth this can be a lengthy process. For ease of access, run the following script to load a pre-downloaded Clair database into the pods:  
`./deploy_db.sh`{{execute}}

## Build a Vulnerable Image

To show how Harbor detects image vulnerabilities, we need to create an image with vulnerabilities in it. We have provided a Dockerfile that creates an image that contains vulnerabilities, so you can build and push this image into Harbor.

1. In your Terminal, log in to the Harbor image registry:  
`docker login -u admin -p kubecon1234 127.0.0.1:30002`{{execute}}
1. Build the demo-api image and push it into Harbor:  
`docker build . -t 127.0.0.1:30002/library/demo-api:vulnerable`{{execute}}  
`docker push 127.0.0.1:30002/library/demo-api:vulnerable`{{execute}}
1. In the Harbor UI, enter the library project and view the demo-api image. The vulnerability rating is shown as `High`, indicating that there is one or more vulnerabilities in the image that have a significant impact.

## Deploy a vulnerable image

We have provided a sample YAML that would deploy your vulnerable image into your cluster

1. Read the YAML. Note that the `image` field has the same name as the image that you pushed earlier:  
`cat demo-api.yaml`{{execute}}
1. Apply the YAML to the cluster:  
`kubectl apply -f demo-api.yaml`{{execute}}
1. Check the pods that were created:  
`kubectl get pods`{{execute}}  
If you have configured Harbor correctly, the pod shows an `ErrImagePull` or `ImagePullBackOff` error.
1. Investigate the reason for the pull failure with:  
`kubectl describe pods #pod-name`{{copy}}  
The event log should show that the image was denied based on its vulnerability:

    ```text
    Failed to pull image "127.0.0.1:30002/library/demo-api:vulnerable": rpc error: code = Unknown desc = Error response from daemon: unknown: The severity of vulnerability of the image: "high" is equal or higher than the threshold in project setting: "low".
    ```

## Fix and deploy secure images

To fix the image and get our app deployed, we need to update the Dockerfile with a secure base image.

1. In the Dockerfile, change the base image to the official `alpine:3.4`{{copy}}, then rebuild and push the demo-api image:  
`vi Dockerfile`{{execute}}  
(use `:wq` to quit `vi`)  
`docker build . -t 127.0.0.1:30002/library/demo-api:secure`{{execute}}  
`docker push 127.0.0.1:30002/library/demo-api:secure`{{execute}}
1. Change the deployment yaml `demo-api.yaml` to reference your new secure image, with the secure tag and redeploy:  
`vi demo-api.yaml`{{execute}}  
`kubectl apply -f demo-api.yaml`{{execute}}

1. Check that the pod has come up now. The image is less vulnerable, so Harbor has allowed it to deploy.
`kubectl get pods`{{execute}}
